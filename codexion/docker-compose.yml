services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: ${POSTGRES_USER:-codexion}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-codexion123}
      POSTGRES_DB: ${POSTGRES_DB:-codexion}
    ports:
      - '5432:5432'
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB']
      interval: 5s
      timeout: 4s
      retries: 20

  edge-gateway:
    build:
      context: ./apps/edge-gateway
    ports:
      - '8787:8787'
    environment:
      PORT: 8787
      # Edge gateway is local-first today (SQLite). Postgres is included for future shared DB work.
      DB_PATH: /app/data/edge-gateway.sqlite
      OFFLINE_MODE: ${OFFLINE_MODE:-false}
      LOCK_PROVIDER: ${LOCK_PROVIDER:-mock}
      MOCK_LOCK_DELAY_MS: ${MOCK_LOCK_DELAY_MS:-400}
      MOCK_LOCK_SUCCESS_RATE: ${MOCK_LOCK_SUCCESS_RATE:-0.9}
      BLE_SCANNER_ENABLED: ${BLE_SCANNER_ENABLED:-false}
      AUTO_SEED_ON_BOOT: ${AUTO_SEED_ON_BOOT:-true}
      # Reserved / future:
      DATABASE_URL: ${DATABASE_URL:-}
    volumes:
      - edge_data:/app/data
      - edge_node_modules:/app/node_modules
      - ./apps/edge-gateway:/app
    depends_on:
      postgres:
        condition: service_healthy
    command: sh -c "npm ci --prefer-offline --no-audit --no-fund && node scripts/migrate.js && node --watch server.js"

  dashboard:
    build:
      context: ./apps/dashboard
    ports:
      - '3000:3000'
    environment:
      NODE_ENV: development
      PORT: 3000
      # These are baked into the browser bundle. Use localhost so your browser can reach the EDGE port mapping.
      NEXT_PUBLIC_EDGE_API_URL: ${NEXT_PUBLIC_EDGE_API_URL:-http://localhost:8787}
      NEXT_PUBLIC_EDGE_WS_URL: ${NEXT_PUBLIC_EDGE_WS_URL:-ws://localhost:8787/ws}
    volumes:
      - dashboard_node_modules:/app/node_modules
      - ./apps/dashboard:/app
    depends_on:
      - edge-gateway
    command: sh -c "npm ci --prefer-offline --no-audit --no-fund && npm run dev -- -p 3000"

  middleware:
    build:
      context: ./apps/middleware
    ports:
      - '8081:8081'
    environment:
      API_HOST: 0.0.0.0
      API_PORT: 8081
      EDGE_GATEWAY_URL: ${EDGE_GATEWAY_URL:-http://edge-gateway:8787}
      WATCH_MAC_ADDRESS: ${WATCH_MAC_ADDRESS:-}
      EDGE_AES256_KEY_B64: ${EDGE_AES256_KEY_B64:-}
      OUTBOX_DB_PATH: /app/runtime/edge_outbox.db
    volumes:
      - middleware_runtime:/app/runtime
      - ./apps/middleware:/app
    depends_on:
      - edge-gateway
    # BLE in containers may require extra privileges on some hosts.
    command: python main.py

volumes:
  postgres_data:
  edge_data:
  edge_node_modules:
  dashboard_node_modules:
  middleware_runtime:
